<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Scan QR → Write Back</title>
<style>
  body{font-family:system-ui;margin:0;padding:16px}
  button{padding:12px 16px;font-size:16px}
  video{width:100%;max-width:520px;margin-top:12px;border:1px solid #ddd;border-radius:8px}
  #result{margin-top:12px;font-size:16px}
</style>

<button id="start">開始掃描</button>
<button id="stop">停止</button>
<video id="v" playsinline muted autoplay></video>
<div id="result">結果：<span id="text">（尚未掃到）</span></div>

<!-- 後備：若無 BarcodeDetector，就用 jsQR 只掃 QR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" crossorigin="anonymous"></script>
<script>
const startBtn = document.getElementById('start');
const stopBtn  = document.getElementById('stop');
const video    = document.getElementById('v');
const textEl   = document.getElementById('text');

let stream, raf, canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
const hasBD = 'BarcodeDetector' in window;
const bd = hasBD ? new BarcodeDetector({formats:['qr_code']}) : null;

function secureOK(){
  const ok = location.protocol==='https:' || location.hostname==='localhost';
  if(!ok) alert('需在 HTTPS 或 localhost 才能開相機（GitHub Pages 會是 https）');
  return ok;
}

async function start(){
  if(!secureOK()) return;
  stop();
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} }, audio:false
    });
    video.srcObject = stream; await video.play();
    tick();
  }catch(e){ alert('無法開啟相機：'+e.message); }
}

function stop(){
  if(raf) cancelAnimationFrame(raf), raf=null;
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
}

async function tick(){
  if(!video.videoWidth){ raf=requestAnimationFrame(tick); return; }
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  try{
    if(bd){
      const codes = await bd.detect(canvas);
      if(codes && codes.length){ onCode(codes[0].rawValue); }
    }else if(window.jsQR){
      const img = ctx.getImageData(0,0,canvas.width,canvas.height);
      const qr = jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});
      if(qr && qr.data){ onCode(qr.data); }
    }
  }catch(e){ /* 忽略單次失敗 */ }

  raf = requestAnimationFrame(tick);
}

function onCode(s){
  textEl.textContent = s;       // ← 回寫到頁面
  // 需要的話也可以：localStorage.setItem('lastQR', s);
}

startBtn.addEventListener('click', start);
stopBtn .addEventListener('click', stop);
window.addEventListener('pagehide', stop);
</script>
